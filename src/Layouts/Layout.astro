---
// Tipos de datos de los props
interface Props {
	title: string;
	description?: string;
	image?: string;
	type?: 'website' | 'article' | 'profile';
	keywords?: string;
}

// Props
const { title, description, image = '/Icons/Icono-Negro.ico', type = 'website', keywords } = Astro.props;

// Componentes
import Navbar from '@/Components/Common/Navbar.astro';
import Footer from '@/Components/Common/Footer.astro';

// Tailwind CSS
import '@/Styles/Default.css';

// Font Awesome 6
import '@/Assets/FontAwesome/css/all.css';

// Lenguaje
import { useLocale } from '@/Hooks/useLocale';
const { currentLocale, t } = useLocale(Astro);

// Transiciones
import { ClientRouter } from 'astro:transitions';

// SEO defaults
const seoDescription = description || t('About.Description');
const siteUrl = Astro.url.origin;
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const ogImageURL = new URL(image, siteUrl);
const currentYear = new Date().getFullYear();

// Keywords por defecto
const defaultKeywords =
	'Ander González, AnderCMD, Full Stack Developer, Software Engineer, React, Astro, TypeScript, Web Development, Desarrollador Web, Ingeniero en Software';
const seoKeywords = keywords ? `${keywords}, ${defaultKeywords}` : defaultKeywords;

// Schema.org JSON-LD
const schemaOrg = {
	'@context': 'https://schema.org',
	'@type': 'Person',
	name: 'Ander González González',
	alternateName: 'AnderCMD',
	jobTitle: 'Full Stack Software Engineer',
	description: seoDescription,
	url: siteUrl,
	image: ogImageURL.href,
	sameAs: ['https://github.com/AnderCMD', 'https://www.linkedin.com/in/andercmd/'],
	knowsAbout: [
		'Software Engineering',
		'Web Development',
		'React',
		'Astro',
		'TypeScript',
		'JavaScript',
		'Full Stack Development',
	],
};
---

<!doctype html>
<html lang={currentLocale} class='scroll-smooth'>
	<head>
		<!-- Essential Meta Tags -->
		<meta charset='UTF-8' />
		<meta name='viewport' content='width=device-width, initial-scale=1.0' />
		<meta http-equiv='X-UA-Compatible' content='IE=edge' />

		<!-- Inline Theme Script - Evita FOUC (Flash of Unstyled Content) -->
		<script is:inline>
			// Función global para obtener la ruta correcta del logo
			window.getLogoPath = function (type, isDark) {
				if (type === 'logo') {
					return isDark ? '/Logos/Logo-Blanco.webp' : '/Logos/Logo-Negro.webp';
				} else {
					return isDark ? '/Logos/Icono-Blanco.webp' : '/Logos/Icono-Negro.webp';
				}
			};

			// Función global para actualizar todos los logos
			window.updateAllLogos = function () {
				const isDark = document.documentElement.classList.contains('dark');
				const logos = document.querySelectorAll('[data-logo-theme]');

				logos.forEach((logo) => {
					const type = logo.getAttribute('data-logo-theme');
					const correctPath = window.getLogoPath(type, isDark);
					const fullPath = window.location.origin + correctPath;

					// Solo actualizar si es diferente
					if (logo.src !== fullPath) {
						logo.src = correctPath;
					}
				});
			};

			// Aplicar tema inmediatamente
			(function () {
				const theme =
					localStorage.getItem('Theme') ||
					(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');

				if (theme === 'dark') {
					document.documentElement.classList.add('dark');
				}

				// Actualizar logos cuando el DOM esté listo
				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', window.updateAllLogos);
				} else {
					window.updateAllLogos();
				}
			})();
		</script>

		<!-- Script para transiciones de Astro -->
		<script>
			// Extender el tipo Window
			declare global {
				interface Window {
					updateAllLogos?: () => void;
					getLogoPath?: (type: string, isDark: boolean) => string;
				}
			}

			// Actualizar logos en cada transición de página
			document.addEventListener('astro:page-load', () => {
				if (window.updateAllLogos) {
					window.updateAllLogos();
				}
			});

			// Actualizar logos ANTES del swap para evitar flickering
			document.addEventListener('astro:before-swap', () => {
				if (window.updateAllLogos) {
					window.updateAllLogos();
				}
			});

			// Actualizar logos DESPUÉS del swap por seguridad
			document.addEventListener('astro:after-swap', () => {
				if (window.updateAllLogos) {
					window.updateAllLogos();
				}
			});
		</script>

		<!-- SEO Meta Tags -->
		<title>{title}</title>
		<meta name='description' content={seoDescription} />
		<meta name='keywords' content={seoKeywords} />
		<meta name='author' content='Ander González González (AnderCMD)' />
		<meta name='generator' content={Astro.generator} />
		<meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1' />
		<link rel='canonical' href={canonicalURL} />

		<!-- Open Graph / Facebook -->
		<meta property='og:type' content={type} />
		<meta property='og:url' content={canonicalURL} />
		<meta property='og:title' content={title} />
		<meta property='og:description' content={seoDescription} />
		<meta property='og:image' content={ogImageURL} />
		<meta property='og:image:width' content='1200' />
		<meta property='og:image:height' content='630' />
		<meta property='og:site_name' content='AnderCMD Portfolio' />
		<meta property='og:locale' content={currentLocale === 'es' ? 'es_MX' : 'en_US'} />

		<!-- Twitter Card -->
		<meta name='twitter:card' content='summary_large_image' />
		<meta name='twitter:url' content={canonicalURL} />
		<meta name='twitter:title' content={title} />
		<meta name='twitter:description' content={seoDescription} />
		<meta name='twitter:image' content={ogImageURL} />
		<meta name='twitter:creator' content='@AnderCMD' />

		<!-- Favicon & Icons -->
		<link rel='icon' type='image/x-icon' href='/Icons/Icono-Negro.ico' />
		<link rel='apple-touch-icon' sizes='180x180' href='/Icons/Icono-Negro.ico' />
		<link rel='manifest' href='/manifest.json' />

		<!-- Preconnect for Performance -->
		<link rel='preconnect' href='https://raw.githubusercontent.com' crossorigin />
		<link rel='preconnect' href='https://cdn.worldvectorlogo.com' crossorigin />
		<link rel='dns-prefetch' href='https://raw.githubusercontent.com' />
		<link rel='dns-prefetch' href='https://cdn.worldvectorlogo.com' />

		<!-- Preload Critical Assets -->
		<link rel='preload' href='/Logos/Icono-Negro.webp' as='image' type='image/webp' />
		<link rel='preload' href='/Logos/Logo-Negro.webp' as='image' type='image/webp' />

		<!-- Preload Critical Fonts -->
		<link rel='preload' href='/src/Assets/Fonts/SF-Pro-Display-Regular.otf' as='font' type='font/otf' crossorigin />
		<link rel='preload' href='/src/Assets/Fonts/SF-Pro-Display-Bold.otf' as='font' type='font/otf' crossorigin />

		<!-- Schema.org JSON-LD -->
		<script type='application/ld+json' set:html={JSON.stringify(schemaOrg)} />

		<!-- Theme Color -->
		<meta name='theme-color' content='#0ea5e9' media='(prefers-color-scheme: light)' />
		<meta name='theme-color' content='#020618' media='(prefers-color-scheme: dark)' />

		<!-- Additional SEO -->
		<meta name='format-detection' content='telephone=no' />
		<meta name='copyright' content={`© ${currentYear} Ander González González. All rights reserved.`} />
		<meta name='language' content={currentLocale} />
		<meta name='revisit-after' content='7 days' />
	</head>

	<body
		class='relative overflow-x-hidden bg-linear-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-950 dark:via-blue-950 dark:to-indigo-950 text-slate-900 dark:text-slate-100 transition-colors duration-300'>
		<!-- Modern Animated Background -->
		<div class='fixed inset-0 -z-10 overflow-hidden'>
			<!-- Gradient Orbs con animación -->
			<div class='absolute inset-0'>
				<!-- Orb 1 - Sky Blue -->
				<div
					class='absolute top-0 left-0 w-96 h-96 bg-sky-400/30 dark:bg-sky-500/20 rounded-full blur-3xl animate-float'
					style='animation-delay: 0s; animation-duration: 20s;'>
				</div>
				<!-- Orb 2 - Blue -->
				<div
					class='absolute top-1/4 right-0 w-120 h-120 bg-blue-500/25 dark:bg-blue-600/15 rounded-full blur-3xl animate-float'
					style='animation-delay: 2s; animation-duration: 25s;'>
				</div>
				<!-- Orb 3 - Indigo -->
				<div
					class='absolute bottom-0 left-1/4 w-md h-112 bg-indigo-500/20 dark:bg-indigo-600/15 rounded-full blur-3xl animate-float'
					style='animation-delay: 4s; animation-duration: 22s;'>
				</div>
				<!-- Orb 4 - Purple -->
				<div
					class='absolute bottom-1/4 right-1/4 w-80 h-80 bg-purple-500/20 dark:bg-purple-600/10 rounded-full blur-3xl animate-float'
					style='animation-delay: 6s; animation-duration: 18s;'>
				</div>
			</div>

			<!-- Grid Pattern Animado -->
			<div class='absolute inset-0 opacity-30 dark:opacity-10'>
				<div
					class='absolute inset-0'
					style='background-image: linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px); background-size: 50px 50px; animation: grid-move 20s linear infinite;'>
				</div>
			</div>

			<!-- Partículas flotantes -->
			<div class='absolute inset-0 overflow-hidden'>
				<div
					class='particle absolute w-1 h-1 bg-sky-500/40 dark:bg-sky-400/30 rounded-full'
					style='top: 10%; left: 10%; animation: float-particle 15s infinite ease-in-out;'>
				</div>
				<div
					class='particle absolute w-1.5 h-1.5 bg-blue-500/40 dark:bg-blue-400/30 rounded-full'
					style='top: 20%; left: 80%; animation: float-particle 18s infinite ease-in-out 2s;'>
				</div>
				<div
					class='particle absolute w-1 h-1 bg-indigo-500/40 dark:bg-indigo-400/30 rounded-full'
					style='top: 60%; left: 20%; animation: float-particle 20s infinite ease-in-out 4s;'>
				</div>
				<div
					class='particle absolute w-2 h-2 bg-purple-500/40 dark:bg-purple-400/30 rounded-full'
					style='top: 80%; left: 70%; animation: float-particle 16s infinite ease-in-out 6s;'>
				</div>
				<div
					class='particle absolute w-1 h-1 bg-sky-500/40 dark:bg-sky-400/30 rounded-full'
					style='top: 40%; left: 60%; animation: float-particle 22s infinite ease-in-out 3s;'>
				</div>
				<div
					class='particle absolute w-1.5 h-1.5 bg-blue-500/40 dark:bg-blue-400/30 rounded-full'
					style='top: 70%; left: 40%; animation: float-particle 19s infinite ease-in-out 5s;'>
				</div>
			</div>

			<!-- Líneas decorativas animadas -->
			<svg class='absolute inset-0 w-full h-full opacity-20 dark:opacity-10' xmlns='http://www.w3.org/2000/svg'>
				<defs>
					<linearGradient id='lineGradient1' x1='0%' y1='0%' x2='100%' y2='100%'>
						<stop offset='0%' style='stop-color: rgb(14, 165, 233); stop-opacity: 0'></stop>
						<stop offset='50%' style='stop-color: rgb(14, 165, 233); stop-opacity: 0.5'></stop>
						<stop offset='100%' style='stop-color: rgb(14, 165, 233); stop-opacity: 0'></stop>
					</linearGradient>
					<linearGradient id='lineGradient2' x1='100%' y1='0%' x2='0%' y2='100%'>
						<stop offset='0%' style='stop-color: rgb(99, 102, 241); stop-opacity: 0'></stop>
						<stop offset='50%' style='stop-color: rgb(99, 102, 241); stop-opacity: 0.5'></stop>
						<stop offset='100%' style='stop-color: rgb(99, 102, 241); stop-opacity: 0'></stop>
					</linearGradient>
				</defs>
				<path
					d='M 0 100 Q 250 50 500 100 T 1000 100'
					stroke='url(#lineGradient1)'
					stroke-width='2'
					fill='none'
					class='animate-path-draw'>
					<animate
						attributeName='d'
						dur='10s'
						repeatCount='indefinite'
						values='M 0 100 Q 250 50 500 100 T 1000 100; M 0 120 Q 250 70 500 120 T 1000 120; M 0 100 Q 250 50 500 100 T 1000 100'
					></animate>
				</path>
				<path
					d='M 1000 300 Q 750 250 500 300 T 0 300'
					stroke='url(#lineGradient2)'
					stroke-width='2'
					fill='none'
					class='animate-path-draw'>
					<animate
						attributeName='d'
						dur='12s'
						repeatCount='indefinite'
						values='M 1000 300 Q 750 250 500 300 T 0 300; M 1000 320 Q 750 270 500 320 T 0 320; M 1000 300 Q 750 250 500 300 T 0 300'
					></animate>
				</path>
			</svg>
		</div>

		<div class='relative flex flex-col min-h-screen'>
			<Navbar />
			<main class='flex-1 container mx-auto px-4 sm:px-6 lg:px-8 xl:px-16 2xl:px-24 py-8 lg:py-12'>
				<ClientRouter />
				<div class='animate-fade-in'>
					<slot />
				</div>
			</main>
			<Footer />
		</div>

		<!-- Scroll to Top Button with Progress -->
		<button id='scroll-to-top' class='fixed bottom-8 right-8 z-50 hidden group' aria-label='Scroll to top'>
			<div class='relative'>
				<!-- Progress Ring -->
				<svg class='w-14 h-14 transform -rotate-90' viewBox='0 0 56 56'>
					<circle
						cx='28'
						cy='28'
						r='24'
						fill='none'
						stroke='currentColor'
						stroke-width='2'
						class='text-slate-200 dark:text-slate-700'></circle>
					<circle
						id='scroll-progress'
						cx='28'
						cy='28'
						r='24'
						fill='none'
						stroke='currentColor'
						stroke-width='2'
						stroke-dasharray='150.8'
						stroke-dashoffset='150.8'
						stroke-linecap='round'
						class='text-sky-500 dark:text-sky-400 transition-all duration-200'></circle>
				</svg>
				<!-- Icon Button -->
				<div class='absolute inset-0 flex items-center justify-center'>
					<div
						class='w-10 h-10 bg-linear-to-br from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500 rounded-full flex items-center justify-center shadow-lg group-hover:shadow-xl group-hover:shadow-sky-500/50 transition-all duration-300 group-hover:scale-110'>
						<i class='fa-solid fa-arrow-up text-white text-sm'></i>
					</div>
				</div>
			</div>
		</button>

		<script>
			// Scroll to top functionality with progress - Optimizado con requestAnimationFrame
			const scrollBtn = document.getElementById('scroll-to-top');
			const progressCircle = document.getElementById('scroll-progress');
			const circumference = 150.8;

			let ticking = false;
			let lastKnownScrollPosition = 0;

			function updateScrollProgress(scrollPos: number) {
				const scrollTotal = document.documentElement.scrollHeight - window.innerHeight;
				const scrollProgress = (scrollPos / scrollTotal) * 100;
				const offset = circumference - (scrollProgress / 100) * circumference;

				if (progressCircle) {
					progressCircle.style.strokeDashoffset = offset.toString();
				}

				if (scrollPos > 300) {
					scrollBtn?.classList.remove('hidden');
					scrollBtn?.classList.add('animate-fade-in');
				} else {
					scrollBtn?.classList.add('hidden');
				}
			}

			function onScroll() {
				lastKnownScrollPosition = window.scrollY;

				if (!ticking) {
					window.requestAnimationFrame(() => {
						updateScrollProgress(lastKnownScrollPosition);
						ticking = false;
					});

					ticking = true;
				}
			}

			// Usar passive event listeners para mejor performance
			window.addEventListener('scroll', onScroll, { passive: true });

			// Debounce para resize
			let resizeTimeout: ReturnType<typeof setTimeout>;
			window.addEventListener(
				'resize',
				() => {
					clearTimeout(resizeTimeout);
					resizeTimeout = setTimeout(() => {
						updateScrollProgress(window.scrollY);
					}, 150);
				},
				{ passive: true }
			);

			scrollBtn?.addEventListener('click', () => {
				window.scrollTo({ top: 0, behavior: 'smooth' });
			});

			// Inicializar
			updateScrollProgress(window.scrollY);
		</script>
	</body>
</html>
